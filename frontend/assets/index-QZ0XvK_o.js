import{_ as te,i as le,h as ae,y,r as d,a as se,ay as oe,z as re,c as f,o as i,d as t,w as a,b as P,aq as ne,I as ie,G as _,E as ue,L as de,B as ce,j as pe,k as me,X as fe,F as b,D as h,Y as _e,H as ge,s as k,t as ve,am as ye,q as be,l as he,m as I,ak as ke,av as Ve,az as Te,a0 as we,C as Le,x as c}from"./index-bBUAzOnK.js";/* empty css                   *//* empty css                *//* empty css                 *//* empty css                  *//* empty css                    *//* empty css               *//* empty css               *//* empty css                  *//* empty css                       */import{u as Ee}from"./dict-EIgV8cgj.js";import{M as Ie}from"./MarkdownEditor-DjlcAQld.js";import{g as xe}from"./asset-C36BtV-d.js";import{b as De,u as Se,s as Ne}from"./vulnerability-BrXE3Fci.js";import"./dict-BgffWH13.js";import"./style-CCN6Cyms.js";import"./file-BNPWs1fO.js";const qe={class:"page-container"},Be={__name:"index",setup(ze){const V=le(),x=ae(),g=Ee(),D=y(()=>!!V.query.id),S=d(null),R=d(null),T=d(!1),w=d(!1),U=y(()=>g.getDictData("vuln_type")),C=y(()=>g.getDictData("risk_level")),M=y(()=>g.getDictData("vuln_source")),O=l=>({critical:"danger",high:"danger",medium:"warning",low:"info"})[l]||"",s=se({title:"",description:"",vulnType:"",riskLevel:"",sourceType:"",assetId:"",attachments:[]}),N=d([]),q=d([]),A=d("/api/file/upload"),F=d({Authorization:"Bearer "+oe()}),H={title:[{required:!0,message:"请输入漏洞标题",trigger:"blur"},{min:5,max:200,message:"标题长度5-200字符",trigger:"blur"}],description:[{required:!0,message:"请输入漏洞描述",trigger:"blur"},{min:20,message:"描述至少20字符",trigger:"blur"}],vulnType:[{required:!0,message:"请选择漏洞类型",trigger:"change"}],riskLevel:[{required:!0,message:"请选择风险等级",trigger:"change"}],sourceType:[{required:!0,message:"请选择漏洞来源",trigger:"change"}],assetId:[{required:!0,message:"请选择关联资产",trigger:"change"}]},j=async()=>{try{const l=await xe({current:1,size:1e3});N.value=l.records||[]}catch(l){console.error("加载资产列表失败:",l),c.error("加载资产列表失败")}},G=(l,e,p)=>{l.code===200?(s.attachments.push({fileName:l.data.fileName,filePath:l.data.filePath,fileSize:l.data.fileSize}),c.success("文件上传成功")):c.error("文件上传失败："+l.message)},J=l=>{console.error("文件上传失败:",l),c.error("文件上传失败")},X=(l,e)=>{var n,u;const p=((u=(n=l.response)==null?void 0:n.data)==null?void 0:u.fileName)||l.name,r=s.attachments.findIndex(m=>m.fileName===p);r>-1&&s.attachments.splice(r,1)},Y=async()=>{var l,e,p;try{await S.value.validate(),w.value=!0;const r={title:s.title,description:s.description,vulnType:s.vulnType,riskLevel:s.riskLevel,sourceType:s.sourceType,assetId:s.assetId,attachmentPaths:s.attachments.map(n=>n.filePath)};console.log("提交数据:",r),D.value?(await Se(V.query.id,r),c.success("漏洞更新成功！")):(await Ne(r),c.success("漏洞提交成功！")),setTimeout(()=>{x.push("/vulnerability/list")},1e3)}catch(r){if(r!==!1){console.error("提交漏洞失败 - 完整错误:",r),console.error("错误响应:",r.response),console.error("错误数据:",(l=r.response)==null?void 0:l.data);const n=((p=(e=r.response)==null?void 0:e.data)==null?void 0:p.message)||r.message||JSON.stringify(r);c.error("提交失败："+n)}}finally{w.value=!1}},B=()=>{x.back()},K=async()=>{if(D.value){T.value=!0;try{const l=await De(V.query.id);s.title=l.title,s.description=l.description,s.vulnType=l.vulnType,s.riskLevel=l.riskLevel,s.sourceType=l.sourceType,s.assetId=String(l.assetId),l.attachments&&l.attachments.length>0&&(q.value=l.attachments.map(e=>({name:e.fileName,url:e.filePath})),s.attachments=l.attachments.map(e=>({fileName:e.fileName,filePath:e.filePath,fileSize:e.fileSize||0})))}catch(l){console.error("加载漏洞详情失败:",l),c.error("加载漏洞详情失败")}finally{T.value=!1}}};return re(async()=>{await g.loadDicts(["vuln_type","risk_level","vuln_source"]),j(),K()}),(l,e)=>{const p=ne,r=me,n=pe,u=ce,m=_e,v=fe,z=de,Q=ge,L=he,E=be,W=ye,Z=ue,$=Le,ee=we;return i(),f("div",qe,[t(p,{onBack:B,class:"mb-20"},{content:a(()=>[...e[6]||(e[6]=[P("span",{class:"page-title"},"提交漏洞",-1)])]),_:1}),t($,{shadow:"never"},{default:a(()=>[ie((i(),_(Z,{ref_key:"formRef",ref:S,model:s,rules:H,"label-width":"120px"},{default:a(()=>[t(z,{gutter:20},{default:a(()=>[t(u,{span:12},{default:a(()=>[t(n,{label:"漏洞标题",prop:"title"},{default:a(()=>[t(r,{modelValue:s.title,"onUpdate:modelValue":e[0]||(e[0]=o=>s.title=o),placeholder:"请输入漏洞标题",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1}),t(u,{span:12},{default:a(()=>[t(n,{label:"关联资产",prop:"assetId"},{default:a(()=>[t(v,{modelValue:s.assetId,"onUpdate:modelValue":e[1]||(e[1]=o=>s.assetId=o),placeholder:"请选择资产",filterable:"",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(N.value,o=>(i(),_(m,{key:o.id,label:o.assetName,value:String(o.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(z,{gutter:20},{default:a(()=>[t(u,{span:8},{default:a(()=>[t(n,{label:"漏洞类型",prop:"vulnType"},{default:a(()=>[t(v,{modelValue:s.vulnType,"onUpdate:modelValue":e[2]||(e[2]=o=>s.vulnType=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(U.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:8},{default:a(()=>[t(n,{label:"风险等级",prop:"riskLevel"},{default:a(()=>[t(v,{modelValue:s.riskLevel,"onUpdate:modelValue":e[3]||(e[3]=o=>s.riskLevel=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(C.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},{default:a(()=>[t(Q,{type:O(o.dictValue),size:"small"},{default:a(()=>[k(ve(o.dictLabel),1)]),_:2},1032,["type"])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:8},{default:a(()=>[t(n,{label:"漏洞来源",prop:"sourceType"},{default:a(()=>[t(v,{modelValue:s.sourceType,"onUpdate:modelValue":e[4]||(e[4]=o=>s.sourceType=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(M.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(n,{label:"漏洞描述",prop:"description"},{default:a(()=>[t(Ie,{modelValue:s.description,"onUpdate:modelValue":e[5]||(e[5]=o=>s.description=o),placeholder:`请详细描述漏洞详情，包括：
1. 漏洞位置
2. 漏洞成因
3. 复现步骤
4. 危害影响
5. 修复建议`,height:"600px"},null,8,["modelValue"])]),_:1}),t(n,{label:"附件上传"},{default:a(()=>[t(W,{ref_key:"uploadRef",ref:R,action:A.value,headers:F.value,"on-success":G,"on-error":J,"on-remove":X,"file-list":q.value,limit:10,multiple:""},{tip:a(()=>[...e[8]||(e[8]=[P("div",{class:"el-upload__tip"}," 支持上传截图、POC文件等，单个文件不超过50MB，最多10个文件 ",-1)])]),default:a(()=>[t(E,{type:"primary"},{default:a(()=>[t(L,null,{default:a(()=>[t(I(ke))]),_:1}),e[7]||(e[7]=k(" 上传附件 ",-1))]),_:1})]),_:1},8,["action","headers","file-list"])]),_:1}),t(n,null,{default:a(()=>[t(E,{type:"primary",onClick:Y,loading:w.value},{default:a(()=>[t(L,null,{default:a(()=>[t(I(Ve))]),_:1}),e[9]||(e[9]=k(" 提交漏洞 ",-1))]),_:1},8,["loading"]),t(E,{onClick:B},{default:a(()=>[t(L,null,{default:a(()=>[t(I(Te))]),_:1}),e[10]||(e[10]=k(" 取消 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])),[[ee,T.value]])]),_:1})])}}},Ze=te(Be,[["__scopeId","data-v-3ae80afb"]]);export{Ze as default};
