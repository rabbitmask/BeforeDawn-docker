import{_ as le,i as te,h as ae,aG as se,y,r as d,a as oe,aL as re,z as ne,c as f,o as i,d as l,w as a,b as R,aB as ie,J as ue,H as _,E as de,M as ce,C as pe,j as me,k as fe,Z as _e,F as b,G as h,$ as ge,I as ve,s as V,t as ye,ax as be,q as he,l as Ve,m as I,au as ke,aI as Te,aM as we,a2 as Le,D as Ee,x as c}from"./index-P-kv1zA8.js";/* empty css                   *//* empty css                *//* empty css                 *//* empty css                  *//* empty css                    *//* empty css               *//* empty css               *//* empty css                  *//* empty css                       */import{M as Ie}from"./MarkdownEditor-L8YTkoZp.js";import{g as xe}from"./asset-BQObA34q.js";import{b as De,u as Se,s as Ne}from"./vulnerability-DkKcdRS0.js";import"./style-WFyn0wIQ.js";import"./file-SAOvPrPe.js";const qe={class:"page-container"},Be={__name:"index",setup(Pe){const k=te(),x=ae(),g=se(),D=y(()=>!!k.query.id),S=d(null),U=d(null),T=d(!1),w=d(!1),z=y(()=>g.getDictData("vuln_type")),C=y(()=>g.getDictData("risk_level")),M=y(()=>g.getDictData("vuln_source")),O=t=>({critical:"danger",high:"danger",medium:"warning",low:"info"})[t]||"",s=oe({title:"",description:"",vulnType:"",riskLevel:"",sourceType:"",assetId:"",attachments:[]}),N=d([]),q=d([]),A=d("/api/file/upload"),F=d({Authorization:"Bearer "+re()}),H={title:[{required:!0,message:"请输入漏洞标题",trigger:"blur"},{min:5,max:200,message:"标题长度5-200字符",trigger:"blur"}],description:[{required:!0,message:"请输入漏洞描述",trigger:"blur"},{min:20,message:"描述至少20字符",trigger:"blur"}],vulnType:[{required:!0,message:"请选择漏洞类型",trigger:"change"}],riskLevel:[{required:!0,message:"请选择风险等级",trigger:"change"}],sourceType:[{required:!0,message:"请选择漏洞来源",trigger:"change"}],assetId:[{required:!0,message:"请选择关联资产",trigger:"change"}]},G=async()=>{try{const t=await xe({current:1,size:1e3});N.value=t.records||[]}catch(t){console.error("加载资产列表失败:",t),c.error("加载资产列表失败")}},J=(t,e,p)=>{t.code===200?(s.attachments.push({fileName:t.data.fileName,filePath:t.data.filePath,fileSize:t.data.fileSize}),c.success("文件上传成功")):c.error("文件上传失败："+t.message)},j=t=>{console.error("文件上传失败:",t),c.error("文件上传失败")},Z=(t,e)=>{var n,u;const p=((u=(n=t.response)==null?void 0:n.data)==null?void 0:u.fileName)||t.name,r=s.attachments.findIndex(m=>m.fileName===p);r>-1&&s.attachments.splice(r,1)},$=async()=>{var t,e,p;try{await S.value.validate(),w.value=!0;const r={title:s.title,description:s.description,vulnType:s.vulnType,riskLevel:s.riskLevel,sourceType:s.sourceType,assetId:s.assetId,attachmentPaths:s.attachments.map(n=>n.filePath)};console.log("提交数据:",r),D.value?(await Se(k.query.id,r),c.success("漏洞更新成功！")):(await Ne(r),c.success("漏洞提交成功！")),setTimeout(()=>{x.push("/vulnerability/list")},1e3)}catch(r){if(r!==!1){console.error("提交漏洞失败 - 完整错误:",r),console.error("错误响应:",r.response),console.error("错误数据:",(t=r.response)==null?void 0:t.data);const n=((p=(e=r.response)==null?void 0:e.data)==null?void 0:p.message)||r.message||JSON.stringify(r);c.error("提交失败："+n)}}finally{w.value=!1}},B=()=>{x.back()},K=async()=>{if(D.value){T.value=!0;try{const t=await De(k.query.id);s.title=t.title,s.description=t.description,s.vulnType=t.vulnType,s.riskLevel=t.riskLevel,s.sourceType=t.sourceType,s.assetId=String(t.assetId),t.attachments&&t.attachments.length>0&&(q.value=t.attachments.map(e=>({name:e.fileName,url:e.filePath})),s.attachments=t.attachments.map(e=>({fileName:e.fileName,filePath:e.filePath,fileSize:e.fileSize||0})))}catch(t){console.error("加载漏洞详情失败:",t),c.error("加载漏洞详情失败")}finally{T.value=!1}}};return ne(async()=>{await g.loadDicts(["vuln_type","risk_level","vuln_source"]),G(),K()}),(t,e)=>{const p=ie,r=fe,n=me,u=pe,m=ge,v=_e,P=ce,Q=ve,L=Ve,E=he,W=be,X=de,Y=Ee,ee=Le;return i(),f("div",qe,[l(p,{onBack:B,class:"mb-20"},{content:a(()=>[...e[6]||(e[6]=[R("span",{class:"page-title"},"提交漏洞",-1)])]),_:1}),l(Y,{shadow:"never"},{default:a(()=>[ue((i(),_(X,{ref_key:"formRef",ref:S,model:s,rules:H,"label-width":"120px"},{default:a(()=>[l(P,{gutter:20},{default:a(()=>[l(u,{span:12},{default:a(()=>[l(n,{label:"漏洞标题",prop:"title"},{default:a(()=>[l(r,{modelValue:s.title,"onUpdate:modelValue":e[0]||(e[0]=o=>s.title=o),placeholder:"请输入漏洞标题",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1}),l(u,{span:12},{default:a(()=>[l(n,{label:"关联资产",prop:"assetId"},{default:a(()=>[l(v,{modelValue:s.assetId,"onUpdate:modelValue":e[1]||(e[1]=o=>s.assetId=o),placeholder:"请选择资产",filterable:"",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(N.value,o=>(i(),_(m,{key:o.id,label:o.assetName,value:String(o.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(P,{gutter:20},{default:a(()=>[l(u,{span:8},{default:a(()=>[l(n,{label:"漏洞类型",prop:"vulnType"},{default:a(()=>[l(v,{modelValue:s.vulnType,"onUpdate:modelValue":e[2]||(e[2]=o=>s.vulnType=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(z.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(u,{span:8},{default:a(()=>[l(n,{label:"风险等级",prop:"riskLevel"},{default:a(()=>[l(v,{modelValue:s.riskLevel,"onUpdate:modelValue":e[3]||(e[3]=o=>s.riskLevel=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(C.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},{default:a(()=>[l(Q,{type:O(o.dictValue),size:"small"},{default:a(()=>[V(ye(o.dictLabel),1)]),_:2},1032,["type"])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(u,{span:8},{default:a(()=>[l(n,{label:"漏洞来源",prop:"sourceType"},{default:a(()=>[l(v,{modelValue:s.sourceType,"onUpdate:modelValue":e[4]||(e[4]=o=>s.sourceType=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(M.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(n,{label:"漏洞描述",prop:"description"},{default:a(()=>[l(Ie,{modelValue:s.description,"onUpdate:modelValue":e[5]||(e[5]=o=>s.description=o),placeholder:`请详细描述漏洞详情，包括：
1. 漏洞位置
2. 漏洞成因
3. 复现步骤
4. 危害影响
5. 修复建议`,height:"600px"},null,8,["modelValue"])]),_:1}),l(n,{label:"附件上传"},{default:a(()=>[l(W,{ref_key:"uploadRef",ref:U,action:A.value,headers:F.value,"on-success":J,"on-error":j,"on-remove":Z,"file-list":q.value,limit:10,multiple:""},{tip:a(()=>[...e[8]||(e[8]=[R("div",{class:"el-upload__tip"}," 支持上传截图、POC文件等，单个文件不超过50MB，最多10个文件 ",-1)])]),default:a(()=>[l(E,{type:"primary"},{default:a(()=>[l(L,null,{default:a(()=>[l(I(ke))]),_:1}),e[7]||(e[7]=V(" 上传附件 ",-1))]),_:1})]),_:1},8,["action","headers","file-list"])]),_:1}),l(n,null,{default:a(()=>[l(E,{type:"primary",onClick:$,loading:w.value},{default:a(()=>[l(L,null,{default:a(()=>[l(I(Te))]),_:1}),e[9]||(e[9]=V(" 提交漏洞 ",-1))]),_:1},8,["loading"]),l(E,{onClick:B},{default:a(()=>[l(L,null,{default:a(()=>[l(I(we))]),_:1}),e[10]||(e[10]=V(" 取消 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])),[[ee,T.value]])]),_:1})])}}},Qe=le(Be,[["__scopeId","data-v-3ae80afb"]]);export{Qe as default};
