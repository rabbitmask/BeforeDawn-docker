import{_ as le,g as te,f as ae,q as se,s as y,r as d,a as oe,aT as re,t as ne,c as f,o as i,e as l,w as a,b as U,aK as ie,G as ue,C as _,h as de,K as ce,y as pe,j as me,k as fe,X as _e,F as b,B as h,Y as ge,D as ve,n as V,z as ye,aH as be,m as he,H as Ve,A as N,aE as ke,aQ as Te,aU as we,a0 as Le,E as Ee,p as c}from"./index-DG9m7imz.js";/* empty css                   *//* empty css                *//* empty css                 *//* empty css                  *//* empty css                    *//* empty css               *//* empty css               *//* empty css                  *//* empty css                   *//* empty css                       */import{M as Ne}from"./MarkdownEditor-D0NXjIJk.js";import{g as Se}from"./asset-BrAUgAmC.js";import{b as De,u as Ie,s as xe}from"./vulnerability-BPpAdgVn.js";import"./style-CLzRKhDd.js";import"./file-upULJF5v.js";const ze={class:"page-container"},qe={__name:"index",setup(Be){const k=te(),S=ae(),g=se(),D=y(()=>!!k.query.id),I=d(null),P=d(null),T=d(!1),w=d(!1),R=y(()=>g.getDictData("vuln_type")),C=y(()=>g.getDictData("risk_level")),M=y(()=>g.getDictData("vuln_source")),O=t=>({critical:"danger",high:"danger",medium:"warning",low:"info"})[t]||"",s=oe({title:"",description:"",vulnType:"",riskLevel:"",sourceType:"",assetId:"",attachments:[]}),x=d([]),z=d([]),A=d("/api/file/upload"),F=d({Authorization:"Bearer "+re()}),H={title:[{required:!0,message:"请输入漏洞标题",trigger:"blur"},{min:5,max:200,message:"标题长度5-200字符",trigger:"blur"}],description:[{required:!0,message:"请输入漏洞描述",trigger:"blur"},{min:20,message:"描述至少20字符",trigger:"blur"}],vulnType:[{required:!0,message:"请选择漏洞类型",trigger:"change"}],riskLevel:[{required:!0,message:"请选择风险等级",trigger:"change"}],sourceType:[{required:!0,message:"请选择漏洞来源",trigger:"change"}],assetId:[{required:!0,message:"请选择关联资产",trigger:"change"}]},K=async()=>{try{const t=await Se({current:1,size:1e3});x.value=t.records||[]}catch(t){console.error("加载资产列表失败:",t),c.error("加载资产列表失败")}},j=(t,e,p)=>{t.code===200?(s.attachments.push({fileName:t.data.fileName,filePath:t.data.filePath,fileSize:Number(t.data.fileSize||e.size||0)}),c.success("文件上传成功")):c.error("文件上传失败："+t.message)},G=t=>{console.error("文件上传失败:",t),c.error("文件上传失败")},J=(t,e)=>{var r,u;const p=((u=(r=t.response)==null?void 0:r.data)==null?void 0:u.fileName)||t.name,n=s.attachments.findIndex(m=>m.fileName===p);n>-1&&s.attachments.splice(n,1)},Q=async()=>{var t,e,p;try{await I.value.validate(),w.value=!0;const n={title:s.title,description:s.description,vulnType:s.vulnType,riskLevel:s.riskLevel,sourceType:s.sourceType,assetId:s.assetId,attachments:s.attachments.map(r=>({fileName:r.fileName,filePath:r.filePath,fileSize:r.fileSize}))};console.log("提交数据:",n),D.value?(await Ie(k.query.id,n),c.success("漏洞更新成功！")):(await xe(n),c.success("漏洞提交成功！")),setTimeout(()=>{S.push("/vulnerability/list")},1e3)}catch(n){if(n!==!1){console.error("提交漏洞失败 - 完整错误:",n),console.error("错误响应:",n.response),console.error("错误数据:",(t=n.response)==null?void 0:t.data);const r=((p=(e=n.response)==null?void 0:e.data)==null?void 0:p.message)||n.message||JSON.stringify(n);c.error("提交失败："+r)}}finally{w.value=!1}},q=()=>{S.back()},X=async()=>{if(D.value){T.value=!0;try{const t=await De(k.query.id);s.title=t.title,s.description=t.description,s.vulnType=t.vulnType,s.riskLevel=t.riskLevel,s.sourceType=t.sourceType,s.assetId=String(t.assetId),t.attachments&&t.attachments.length>0&&(z.value=t.attachments.map(e=>({name:e.fileName,url:e.filePath})),s.attachments=t.attachments.map(e=>({fileName:e.fileName,filePath:e.filePath,fileSize:e.fileSize||0})))}catch(t){console.error("加载漏洞详情失败:",t),c.error("加载漏洞详情失败")}finally{T.value=!1}}};return ne(async()=>{await g.loadDicts(["vuln_type","risk_level","vuln_source"]),K(),X()}),(t,e)=>{const p=ie,n=fe,r=me,u=pe,m=ge,v=_e,B=ce,Y=ve,L=Ve,E=he,W=be,Z=de,$=Ee,ee=Le;return i(),f("div",ze,[l(p,{onBack:q,class:"mb-20"},{content:a(()=>[...e[6]||(e[6]=[U("span",{class:"page-title"},"提交漏洞",-1)])]),_:1}),l($,{shadow:"never"},{default:a(()=>[ue((i(),_(Z,{ref_key:"formRef",ref:I,model:s,rules:H,"label-width":"120px"},{default:a(()=>[l(B,{gutter:20},{default:a(()=>[l(u,{span:12},{default:a(()=>[l(r,{label:"漏洞标题",prop:"title"},{default:a(()=>[l(n,{modelValue:s.title,"onUpdate:modelValue":e[0]||(e[0]=o=>s.title=o),placeholder:"请输入漏洞标题",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1}),l(u,{span:12},{default:a(()=>[l(r,{label:"关联资产",prop:"assetId"},{default:a(()=>[l(v,{modelValue:s.assetId,"onUpdate:modelValue":e[1]||(e[1]=o=>s.assetId=o),placeholder:"请选择资产",filterable:"",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(x.value,o=>(i(),_(m,{key:o.id,label:o.assetName,value:String(o.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(B,{gutter:20},{default:a(()=>[l(u,{span:8},{default:a(()=>[l(r,{label:"漏洞类型",prop:"vulnType"},{default:a(()=>[l(v,{modelValue:s.vulnType,"onUpdate:modelValue":e[2]||(e[2]=o=>s.vulnType=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(R.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(u,{span:8},{default:a(()=>[l(r,{label:"风险等级",prop:"riskLevel"},{default:a(()=>[l(v,{modelValue:s.riskLevel,"onUpdate:modelValue":e[3]||(e[3]=o=>s.riskLevel=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(C.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},{default:a(()=>[l(Y,{type:O(o.dictValue),size:"small"},{default:a(()=>[V(ye(o.dictLabel),1)]),_:2},1032,["type"])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(u,{span:8},{default:a(()=>[l(r,{label:"漏洞来源",prop:"sourceType"},{default:a(()=>[l(v,{modelValue:s.sourceType,"onUpdate:modelValue":e[4]||(e[4]=o=>s.sourceType=o),placeholder:"请选择",style:{width:"100%"}},{default:a(()=>[(i(!0),f(b,null,h(M.value,o=>(i(),_(m,{key:o.dictValue,label:o.dictLabel,value:o.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(r,{label:"漏洞描述",prop:"description"},{default:a(()=>[l(Ne,{modelValue:s.description,"onUpdate:modelValue":e[5]||(e[5]=o=>s.description=o),placeholder:`请详细描述漏洞详情，包括：
1. 漏洞位置
2. 漏洞成因
3. 复现步骤
4. 危害影响
5. 修复建议`,height:"600px"},null,8,["modelValue"])]),_:1}),l(r,{label:"附件上传"},{default:a(()=>[l(W,{ref_key:"uploadRef",ref:P,action:A.value,headers:F.value,"on-success":j,"on-error":G,"on-remove":J,"file-list":z.value,limit:10,multiple:""},{tip:a(()=>[...e[8]||(e[8]=[U("div",{class:"el-upload__tip"}," 支持上传截图、POC文件等，单个文件不超过50MB，最多10个文件 ",-1)])]),default:a(()=>[l(E,{type:"primary"},{default:a(()=>[l(L,null,{default:a(()=>[l(N(ke))]),_:1}),e[7]||(e[7]=V(" 上传附件 ",-1))]),_:1})]),_:1},8,["action","headers","file-list"])]),_:1}),l(r,null,{default:a(()=>[l(E,{type:"primary",onClick:Q,loading:w.value},{default:a(()=>[l(L,null,{default:a(()=>[l(N(Te))]),_:1}),e[9]||(e[9]=V(" 提交漏洞 ",-1))]),_:1},8,["loading"]),l(E,{onClick:q},{default:a(()=>[l(L,null,{default:a(()=>[l(N(we))]),_:1}),e[10]||(e[10]=V(" 取消 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])),[[ee,T.value]])]),_:1})])}}},We=le(qe,[["__scopeId","data-v-b8e1946d"]]);export{We as default};
